const firebaseConfig={apiKey:"AIzaSyBG_54h3xkGoGwfX_3kFLRUciTdEkmkrvA",authDomain:"shakzztv-de597.firebaseapp.com",databaseURL:"https://shakzztv-de597-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"shakzztv-de597",storageBucket:"shakzztv-de597.firebasestorage.app",messagingSenderId:"841207969238",appId:"1:841207969238:web:4f173cc794f99494c5e077",measurementId:"G-FZQTKE7STD"};let db=null;let messagesRef=null;try{if(typeof firebase!=='undefined'&&firebaseConfig.apiKey){if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
db=firebase.database();messagesRef=db.ref('messages/global');console.log("ðŸ”¥ Firebase Connected!")}else{console.warn("âš ï¸ Firebase SDK not loaded. Chat will be offline.")}}catch(e){console.error("Firebase Init Error:",e)}
const cutieStyles=document.createElement('style');cutieStyles.textContent=`
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .cutie-loader { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; color: white; font-family: 'Outfit', sans-serif; }
  .cutie-loader-content { text-align: center; }
  .cutie-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
  .cutie-retry-btn { padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px; }
  .cutie-error-msg { color: #ef4444; padding: 20px; text-align: center; }
  .cutie-hide { display: none !important; }
`;document.head.appendChild(cutieStyles);const CutieLoader={show:(msg="Loading channels...")=>{let loader=document.getElementById('cutieGlobalLoader');if(!loader){loader=document.createElement('div');loader.id='cutieGlobalLoader';loader.className='cutie-loader';loader.innerHTML=`
                <div class="cutie-loader-content">
                    <div class="cutie-spinner"></div>
                    <p id="loaderMessage">${msg}</p>
                    <button id="cutieRetryBtn" class="cutie-retry-btn cutie-hide">Retry</button>
                </div>
            `;document.body.appendChild(loader)}
const msgEl=document.getElementById('loaderMessage');if(msgEl)msgEl.textContent=msg;return loader},hide:()=>{const loader=document.getElementById('cutieGlobalLoader');if(loader)loader.remove();},error:(msg)=>{CutieLoader.show(`Error: ${msg}`);const spinner=document.querySelector('.cutie-spinner');if(spinner)spinner.style.display='none';const retry=document.getElementById('cutieRetryBtn');if(retry){retry.onclick=()=>location.reload();retry.classList.remove('cutie-hide')}}};const DEFAULT_CHANNEL_ID="Kapamilya";let shownCount=0;let currentSearchFilter="";let currentChannelKey="";const tabs=["all","favorites","news","entertainment","movies","sports","documentary","cartoons & animations"];let currentTabIndex=0;let sortedChannels=[];let focusedElement=null;let viewerInterval=null;let notificationInterval=null;let maintenanceInterval=null;(function(){'use strict';const CONFIG={NICK_KEY:'shakzz_nick_v3',AVATAR_KEY:'shakzz_avatar_v3',FIREBASE_CONFIG:null,API_KEY:'',MAX_MSG_AGE:24*60*60*1000};const state={userNickname:localStorage.getItem(CONFIG.NICK_KEY)||null,userAvatar:localStorage.getItem(CONFIG.AVATAR_KEY)||null,selectedFile:null,messagesRef:null,cameraStream:null,selectedMessageId:null,isRecording:!1,mediaRecorder:null,recordedChunks:[],recordStartTime:0,recordTimerInt:null,audioCtx:null,analyser:null,dataArray:null,visualizerReqId:null,visualizerBars:[],replyingToMsg:null,msgReactions:{},editingMessageId:null,currentDurationSec:0,longPressTimer:null,isScrolling:!1,isTouch:'ontouchstart' in window};const mockUsers=[{name:'ShakzzAI',avatar:'https://ui-avatars.com/api/?name=AI&background=00c6ff&color=fff'},{name:'ShakzzBot',avatar:null},{name:'Admin',avatar:null}];let els={};function refreshElements(){els={fab:document.getElementById('chatFab'),container:document.getElementById('chatContainer'),closeBtn:document.getElementById('closeChatBtn'),setup:document.getElementById('setupScreen'),messages:document.getElementById('chatMessagesList'),inputArea:document.getElementById('mainInputArea'),normalControls:document.getElementById('normalControls'),recordingControls:document.getElementById('recordingControls'),contextControls:document.getElementById('contextControls'),input:document.getElementById('chatInput'),cameraBtn:document.getElementById('cameraBtn'),attachBtn:document.getElementById('attachBtn'),recordBtn:document.getElementById('recordBtn'),sendBtn:document.getElementById('sendBtn'),cancelRecBtn:document.getElementById('cancelRecordBtn'),finishRecBtn:document.getElementById('finishRecordBtn'),recTimer:document.getElementById('recordingTimer'),visualizerCanvas:document.getElementById('visualizerCanvas'),fileInput:document.getElementById('chatFileInput'),previewBar:document.getElementById('filePreviewBar'),previewImg:document.getElementById('previewImage'),previewVid:document.getElementById('previewVideo'),setupAvatarBtn:document.getElementById('setupAvatarBtn'),setupFileIn:document.getElementById('setupFileInput'),setupDisplay:document.getElementById('setupAvatarDisplay'),setupNickIn:document.getElementById('setupNicknameInput'),setupFinish:document.getElementById('finishSetupBtn'),camModal:document.getElementById('cameraModal'),camVideo:document.getElementById('cameraPreview'),camSnap:document.getElementById('snapPhotoBtn'),camClose:document.getElementById('closeCameraBtn'),camCanvas:document.getElementById('cameraCanvas'),reactionPicker:document.getElementById('reactionPicker'),moreModal:document.getElementById('moreOptionsModal'),desktopMenu:document.getElementById('desktopContextMenu'),mobileSheet:document.getElementById('mobileBottomSheetOverlay'),menuEdit:document.getElementById('menuEdit'),menuRemove:document.getElementById('menuRemove'),menuReport:document.getElementById('menuReport'),replyBar:document.getElementById('replyPreviewBar'),replyName:document.getElementById('replyToName'),replyText:document.getElementById('replyToText'),deleteModal:document.getElementById('deleteOptionsModal'),mentionList:document.getElementById('mentionSuggestions')}}
function isEmojiOnly(text){if(!text)return!1;const emojiRegex=/^(\p{Emoji_Presentation}|\p{Extended_Pictographic}|\s)+$/u;return emojiRegex.test(text.trim())}
function init(){refreshElements();if(!els.fab)return;if(state.userNickname)showChat();else showSetup();if(els.fab)els.fab.addEventListener('click',openChat);if(els.closeBtn)els.closeBtn.addEventListener('click',closeChat);if(els.setupAvatarBtn)els.setupAvatarBtn.addEventListener('click',()=>els.setupFileIn.click());if(els.setupFileIn)els.setupFileIn.addEventListener('change',handleSetupFile);if(els.setupFinish)els.setupFinish.addEventListener('click',finishSetup);if(els.input){els.input.addEventListener('input',handleInput);els.input.addEventListener('keydown',handleKeyDown)}
if(els.sendBtn)els.sendBtn.addEventListener('click',handleSend);if(els.recordBtn)els.recordBtn.addEventListener('click',startRecording);if(els.cancelRecBtn)els.cancelRecBtn.addEventListener('click',cancelRecording);if(els.finishRecBtn)els.finishRecBtn.addEventListener('click',finishRecording);if(els.cameraBtn)els.cameraBtn.addEventListener('click',openCamera);if(els.attachBtn)els.attachBtn.addEventListener('click',()=>els.fileInput.click());if(els.fileInput)els.fileInput.addEventListener('change',handleFileSelect);if(els.camClose)els.camClose.addEventListener('click',closeCamera);if(els.camSnap)els.camSnap.addEventListener('click',takeSnap);if(typeof db!=='undefined'&&db){state.messagesRef=db.ref('messages/global')}else if(CONFIG.FIREBASE_CONFIG&&typeof firebase!=='undefined'){firebase.initializeApp(CONFIG.FIREBASE_CONFIG);state.messagesRef=firebase.database().ref('messages/global')}}
function showSetup(){if(els.setup)els.setup.style.display='flex';if(els.messages)els.messages.classList.remove('active');if(els.inputArea)els.inputArea.classList.remove('active');}
function showChat(){if(els.setup)els.setup.style.display='none';if(els.messages)els.messages.classList.add('active');if(els.inputArea)els.inputArea.classList.add('active');loadMessages()}
let tempAvatar=null;function handleSetupFile(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{tempAvatar=ev.target.result;els.setupDisplay.innerHTML=`<img src="${tempAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`};reader.readAsDataURL(file)}
function finishSetup(){let nickname=els.setupNickIn.value.trim();if(!nickname){els.setupNickIn.focus();return}
if(nickname.toLowerCase()==='shakzz'){const pass=prompt("ðŸ”’ Admin Access Required\nEnter Password:");if(pass==='admin2025'){nickname="Shakzz (Admin)";state.userAvatar="Jinwoo.png"}else{alert("âŒ Access Denied: This username is reserved.");els.setupNickIn.value='';return}}
state.userNickname=nickname;if(!state.userAvatar&&tempAvatar)state.userAvatar=tempAvatar;try{localStorage.setItem(CONFIG.NICK_KEY,state.userNickname);if(state.userAvatar)localStorage.setItem(CONFIG.AVATAR_KEY,state.userAvatar);}catch(e){}
showChat()}
function handleInput(){updateSendButton();handleMentionInput()}
function handleKeyDown(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();els.sendBtn.click()}}
function updateSendButton(){const hasText=els.input.value.trim().length>0;const hasFile=!!state.selectedFile;const icon=els.sendBtn.querySelector('i');if(state.editingMessageId)icon.className='fas fa-check';else if(hasText||hasFile)icon.className='fas fa-paper-plane';else icon.className='fas fa-thumbs-up'}
function handleMentionInput(){const value=els.input.value;const cursor=els.input.selectionStart;const lastAt=value.lastIndexOf('@',cursor-1);if(lastAt!==-1){const query=value.substring(lastAt+1,cursor);if(!query.includes(' ')){showMentionSuggestions(query);return}}
hideMentions()}
function showMentionSuggestions(query){const matches=mockUsers.filter(u=>u.name.toLowerCase().startsWith(query.toLowerCase()));if(matches.length>0){els.mentionList.innerHTML=matches.map(u=>`
        <div class="suggestion-item" data-name="${u.name}">
          ${u.avatar ? `<img src="${u.avatar}" class="suggestion-avatar">` : `<div class="suggestion-avatar" style="background:#888;color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px">${u.name[0]}</div>`}
          <span>${u.name}</span>
        </div>`).join('');els.mentionList.style.display='flex';els.mentionList.querySelectorAll('.suggestion-item').forEach(item=>{item.addEventListener('click',()=>selectMention(item.dataset.name))})}else{hideMentions()}}
function hideMentions(){els.mentionList.style.display='none'}
function selectMention(name){const value=els.input.value;const cursor=els.input.selectionStart;const lastAt=value.lastIndexOf('@',cursor-1);els.input.value=`${value.substring(0, lastAt)}@${name} ${value.substring(cursor)}`;hideMentions();els.input.focus()}
async function handleSend(){if(state.editingMessageId){submitEdit();return}
const icon=els.sendBtn.querySelector('i');if(icon.classList.contains('fa-thumbs-up'))sendThumbUp();else await sendMessage()}
function sendThumbUp(){const msg={sender:state.userNickname,avatar:state.userAvatar,text:'ðŸ‘',time:new Date().toISOString(),status:'sent'};sendMessageToDB(msg)}
async function getAIResponse(prompt){if(!CONFIG.API_KEY)return"AI not configured.";const url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.API_KEY}`;try{const response=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});const data=await response.json();if(data.candidates?.length>0)return data.candidates[0].content.parts[0].text;return"No response from AI."}catch(error){return"Sorry, I'm having trouble connecting right now."}}
async function sendMessage(){const text=els.input.value.trim();if(!text&&!state.selectedFile)return;const isAIRequest=text.toLowerCase().includes('@shakzzai');const formattedText=text.replace(/@(\w+)/g,'<span class="mention-tag">@$1</span>');const msg={sender:state.userNickname,avatar:state.userAvatar,text:formattedText,media:state.selectedFile,time:new Date().toISOString(),status:'sending',replyTo:state.replyingToMsg};sendMessageToDB(msg);els.input.value='';clearFile();cancelReply();hideMentions();updateSendButton();if(isAIRequest){const response=await getAIResponse(text);const aiMsg={sender:'ShakzzAI',avatar:null,text:response.replace(/\n/g,'<br>'),time:new Date().toISOString(),isAI:!0};setTimeout(()=>sendMessageToDB(aiMsg),500)}}
function sendMessageToDB(msg){const tempId='local-'+Date.now();appendMessage(msg,tempId);if(state.messagesRef){state.messagesRef.push(msg).then(()=>{const localRow=document.getElementById(`msg-row-${tempId}`);if(localRow)localRow.remove();})}}
async function startRecording(){els.normalControls.style.display='none';els.recordingControls.style.display='flex';try{const stream=await navigator.mediaDevices.getUserMedia({audio:!0});state.cameraStream=stream;state.mediaRecorder=new MediaRecorder(stream);state.recordedChunks=[];state.audioCtx=new(window.AudioContext||window.webkitAudioContext)();state.analyser=state.audioCtx.createAnalyser();const source=state.audioCtx.createMediaStreamSource(stream);source.connect(state.analyser);state.analyser.fftSize=256;state.dataArray=new Uint8Array(state.analyser.frequencyBinCount);state.mediaRecorder.ondataavailable=e=>{if(e.data.size>0)state.recordedChunks.push(e.data);};state.mediaRecorder.onstop=()=>{stream.getTracks().forEach(t=>t.stop());if(state.audioCtx)state.audioCtx.close();cancelAnimationFrame(state.visualizerReqId);resetVisualizer()};state.mediaRecorder.start();state.isRecording=!0;startTimer();startVisualizer()}catch(e){alert('Microphone access denied.');cancelRecording()}}
function cancelRecording(){if(state.mediaRecorder&&state.isRecording){state.mediaRecorder.stop();state.isRecording=!1;state.recordedChunks=[];stopTimer();els.normalControls.style.display='flex';els.recordingControls.style.display='none'}}
function finishRecording(){if(!state.mediaRecorder||!state.isRecording)return;state.mediaRecorder.onstop=()=>{const blob=new Blob(state.recordedChunks,{type:'audio/webm'});const reader=new FileReader();reader.onload=()=>{const msg={sender:state.userNickname,avatar:state.userAvatar,audio:reader.result,time:new Date().toISOString(),status:'sent',duration:state.currentDurationSec};sendMessageToDB(msg)};reader.readAsDataURL(blob);if(state.audioCtx)state.audioCtx.close();cancelAnimationFrame(state.visualizerReqId);resetVisualizer()};state.mediaRecorder.stop();state.isRecording=!1;stopTimer();els.normalControls.style.display='flex';els.recordingControls.style.display='none'}
function startVisualizer(){const canvas=els.visualizerCanvas;const ctx=canvas.getContext('2d');const barWidth=5;const gap=3;function resizeCanvas(){canvas.width=canvas.parentElement.offsetWidth;canvas.height=canvas.parentElement.offsetHeight}
resizeCanvas();function draw(){state.visualizerReqId=requestAnimationFrame(draw);if(!state.analyser)return;state.analyser.getByteFrequencyData(state.dataArray);const maxBars=Math.floor(canvas.width/(barWidth+gap));let sum=0;for(let i=0;i<state.dataArray.length;i++){sum+=state.dataArray[i]}
const level=(sum/state.dataArray.length/255)*canvas.height*1.5;const barHeight=Math.max(4,level);state.visualizerBars.push(barHeight);if(state.visualizerBars.length>maxBars)state.visualizerBars.shift();ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';for(let i=0;i<state.visualizerBars.length;i++){const h=state.visualizerBars[i];const x=i*(barWidth+gap);const y=(canvas.height-h)/2;ctx.fillRect(x,y,barWidth,h)}}
draw()}
function resetVisualizer(){const canvas=els.visualizerCanvas;const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);state.visualizerBars=[]}
function startTimer(){state.recordStartTime=Date.now();els.recTimer.textContent='0:00';state.recordTimerInt=setInterval(()=>{const elapsed=Math.floor((Date.now()-state.recordStartTime)/1000);state.currentDurationSec=elapsed;const minutes=Math.floor(elapsed/60);const seconds=(elapsed%60).toString().padStart(2,'0');els.recTimer.textContent=`${minutes}:${seconds}`},1000)}
function stopTimer(){clearInterval(state.recordTimerInt);els.recTimer.textContent='0:00';state.currentDurationSec=0}
function handleTouchStart(e,id){if(!state.isTouch)return;state.isScrolling=!1;state.longPressTimer=setTimeout(()=>{if(!state.isScrolling){const bubble=e.target.closest('.chat-message');if(bubble){openContextMode(id);showReactionPicker(id,bubble)}}},600)}
function handleTouchMove(){state.isScrolling=!0;clearTimeout(state.longPressTimer)}
function handleTouchEnd(){if(!state.isTouch)return;clearTimeout(state.longPressTimer)}
function openContextMode(id){state.selectedMessageId=id;document.querySelectorAll('.message-row').forEach(el=>el.classList.remove('selected'));const row=document.getElementById(`msg-row-${id}`);if(row)row.classList.add('selected');if(state.isTouch){if(els.mobileSheet)els.mobileSheet.classList.add('active');}else{els.normalControls.style.display='none';els.contextControls.style.display='flex'}
if(navigator.vibrate)navigator.vibrate(50);}
function closeContextMode(){state.selectedMessageId=null;document.querySelectorAll('.message-row').forEach(el=>el.classList.remove('selected'));els.normalControls.style.display='flex';els.contextControls.style.display='none';els.reactionPicker.style.display='none';els.reactionPicker.classList.remove('mobile-mode');els.desktopMenu.style.display='none';if(els.mobileSheet)els.mobileSheet.classList.remove('active');}
function showReactionPicker(id,el){state.selectedMessageId=id;const rect=el.getBoundingClientRect();els.reactionPicker.style.display='flex';els.reactionPicker.classList.remove('mobile-mode');let left=rect.left+(rect.width/2)-(els.reactionPicker.offsetWidth/2);let top=rect.top-60;if(left<10)left=10;if(top<10)top=rect.bottom+10;els.reactionPicker.style.left=`${left}px`;els.reactionPicker.style.top=`${top}px`;els.reactionPicker.style.transform='scale(0.5)';setTimeout(()=>els.reactionPicker.style.transform='scale(1)',10);els.reactionPicker.querySelectorAll('.reaction-option').forEach(option=>{option.onclick=()=>handleReaction(option.dataset.emoji)})}
function handleReaction(emoji){if(!state.selectedMessageId)return;const row=document.getElementById(`msg-row-${state.selectedMessageId}`);if(!row)return;if(!state.msgReactions[state.selectedMessageId]){state.msgReactions[state.selectedMessageId]={emoji:null,count:0,userReacted:!1}}
const stateData=state.msgReactions[state.selectedMessageId];const pillContainer=row.querySelector('.reaction-pill-container')||createReactionContainer(row);if(stateData.userReacted&&stateData.emoji===emoji){stateData.count--;stateData.userReacted=!1;stateData.emoji=null;if(stateData.count<=0)pillContainer.innerHTML=''}else{if(!stateData.userReacted)stateData.count++;stateData.emoji=emoji;stateData.userReacted=!0;pillContainer.innerHTML=`<div class="reaction-pill">${emoji} ${stateData.count > 1 ? stateData.count : ''}</div>`}
closeContextMode()}
function createReactionContainer(row){const wrapper=row.querySelector('.chat-message-wrapper');const container=document.createElement('div');container.className='reaction-pill-container';wrapper.appendChild(container);return container}
function showDesktopMenu(e,id,isMe){e.stopPropagation();state.selectedMessageId=id;els.menuEdit.style.display=isMe?'block':'none';els.menuRemove.style.display=isMe?'block':'none';els.menuReport.style.display=isMe?'none':'block';const btn=e.currentTarget;const rect=btn.getBoundingClientRect();const containerRect=els.container.getBoundingClientRect();const menu=els.desktopMenu;menu.style.display='flex';menu.style.visibility='hidden';const menuHeight=menu.offsetHeight;const menuWidth=menu.offsetWidth;menu.style.visibility='visible';const bottomSpace=containerRect.height-rect.bottom;let top,left;if(bottomSpace>=menuHeight+15){top=rect.bottom-containerRect.top+12;menu.classList.add('show-below')}else{top=rect.top-containerRect.top-menuHeight-12;menu.classList.remove('show-below')}
left=rect.left-containerRect.left+rect.width-menuWidth+5;if(left<5)left=5;menu.style.top=top+'px';menu.style.left=left+'px'}
function handleGlobalClick(e){const clickedInsideMessage=e.target.closest('.message-row');const clickedInsidePicker=e.target.closest('#reactionPicker');const clickedInsideModal=e.target.closest('.modal-overlay');const clickedInsideContext=e.target.closest('.input-mode-context');const clickedInsideMenu=e.target.closest('#desktopContextMenu');const clickedInsideSheet=e.target.closest('.mobile-sheet-content');if(!clickedInsideMessage&&!clickedInsidePicker&&!clickedInsideModal&&!clickedInsideContext&&!clickedInsideMenu&&!clickedInsideSheet){closeContextMode()}}
function openModal(){els.moreModal.style.display='flex'}
function closeModal(){els.moreModal.style.display='none'}
function closeDeleteModal(){els.deleteModal.style.display='none'}
function confirmDelete(type){if(!state.selectedMessageId)return;const row=document.getElementById(`msg-row-${state.selectedMessageId}`);const bubble=row.querySelector('.chat-message');if(type==='everyone'){bubble.innerHTML='You unsent a message';bubble.classList.add('unsent');bubble.removeAttribute('contenteditable');const media=row.querySelector('.chat-media-content');if(media&&media.parentNode)media.parentNode.remove();const audio=row.querySelector('.audio-player');if(audio)audio.remove();}else if(type==='me'){row.remove()}
const actions=row.querySelector('.actions-group');if(actions)actions.remove();const status=row.querySelector('.message-status-row');if(status)status.remove();closeDeleteModal();closeContextMode()}
function closeDeleteModal(){if(els.deleteModal)els.deleteModal.classList.remove('active');}
function triggerReplyFromIcon(id){state.selectedMessageId=id;handleModalAction('reply')}
function handleModalAction(action){if(!state.selectedMessageId)return;const row=document.getElementById(`msg-row-${state.selectedMessageId}`);const bubble=row.querySelector('.chat-message');let senderName=state.userNickname;if(row.classList.contains('other')){senderName=row.querySelector('.message-sender')?.textContent||"Unknown"}
switch(action){case 'reply':const displaySender=(senderName===state.userNickname)?"yourself":senderName;state.replyingToMsg={sender:senderName,text:bubble.innerText.substring(0,100)};els.replyName.textContent=displaySender;els.replyText.textContent=state.replyingToMsg.text;els.replyBar.style.display='flex';els.input.focus();break;case 'copy':navigator.clipboard.writeText(bubble.innerText).then(()=>alert('Copied!'));break;case 'edit':enterEditMode(state.selectedMessageId);break;case 'remove':const deleteList=document.getElementById('deleteOptionsList');deleteList.innerHTML='';const isMe=(senderName===state.userNickname);if(isMe){const btnEveryone=document.createElement('div');btnEveryone.className='sheet-list-action danger';btnEveryone.innerHTML='<i class="fas fa-trash-alt"></i> Unsend for Everyone';btnEveryone.onclick=()=>ChatWidget.confirmDelete('everyone');deleteList.appendChild(btnEveryone)}
const btnMe=document.createElement('div');btnMe.className='sheet-list-action';btnMe.innerHTML='<i class="fas fa-user-minus"></i> Remove for You';btnMe.onclick=()=>ChatWidget.confirmDelete('me');deleteList.appendChild(btnMe);els.deleteModal.classList.add('active');return;case 'bump':const bumpNote=document.createElement('div');bumpNote.className='bump-notice';bumpNote.textContent='You bumped your message';row.querySelector('.chat-message-wrapper').prepend(bumpNote);els.messages.appendChild(row);els.messages.scrollTop=els.messages.scrollHeight;break;case 'report':alert('Reported.');break}
closeModal();closeContextMode()}
function cancelReply(){state.replyingToMsg=null;els.replyBar.style.display='none'}
function enterEditMode(id){state.editingMessageId=id;const row=document.getElementById(`msg-row-${id}`);const bubble=row.querySelector('.chat-message');if(bubble.classList.contains('unsent'))return;const isEmoji=bubble.classList.contains('emoji-only');if(isEmoji)bubble.classList.remove('emoji-only');const originalText=bubble.innerText.replace('(edited)','').trim();bubble.setAttribute('contenteditable','true');bubble.focus();const range=document.createRange();const sel=window.getSelection();range.selectNodeContents(bubble);range.collapse(!1);sel.removeAllRanges();sel.addRange(range);const handleKeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitEdit(bubble,handleKeydown);if(isEmoji&&isEmojiOnly(bubble.innerText))bubble.classList.add('emoji-only');}else if(e.key==='Escape'){cancelEdit(bubble,originalText,handleKeydown);if(isEmoji)bubble.classList.add('emoji-only');}};bubble.addEventListener('keydown',handleKeydown)}
function submitEdit(bubble,handler){const newText=bubble.innerText.replace('(edited)','').trim();bubble.removeAttribute('contenteditable');bubble.removeEventListener('keydown',handler);if(newText){const quote=bubble.querySelector('.reply-quote-bubble');bubble.innerHTML=(quote?quote.outerHTML:'')+newText+'<span class="edited-label">(edited)</span>'}else{bubble.innerText="Empty"}
state.editingMessageId=null;updateSendButton()}
function cancelEdit(bubble,originalText,handler){bubble.removeAttribute('contenteditable');bubble.removeEventListener('keydown',handler);bubble.innerHTML=originalText;state.editingMessageId=null;updateSendButton()}
async function openCamera(){els.camModal.style.display='flex';try{state.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});els.camVideo.srcObject=state.cameraStream}catch(e){alert('Camera access denied.');closeCamera()}}
function closeCamera(){if(state.cameraStream){state.cameraStream.getTracks().forEach(t=>t.stop());state.cameraStream=null}
if(els.camModal)els.camModal.style.display='none'}
function takeSnap(){const video=els.camVideo;const canvas=els.camCanvas;canvas.width=video.videoWidth;canvas.height=video.videoHeight;const ctx=canvas.getContext('2d');ctx.translate(canvas.width,0);ctx.scale(-1,1);ctx.drawImage(video,0,0);state.selectedFile=canvas.toDataURL('image/jpeg');closeCamera();showFilePreview(state.selectedFile,'image')}
function handleFileSelect(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{state.selectedFile=ev.target.result;showFilePreview(state.selectedFile,file.type.startsWith('video/')?'video':'image')};reader.readAsDataURL(file)}
function showFilePreview(src,type){els.previewBar.classList.add('active');if(type==='video'){els.previewVid.src=src;els.previewVid.style.display='block';els.previewImg.style.display='none'}else{els.previewImg.src=src;els.previewImg.style.display='block';els.previewVid.style.display='none'}
updateSendButton()}
function clearFile(){state.selectedFile=null;els.fileInput.value='';els.previewBar.classList.remove('active');updateSendButton()}
window.playAudio=function(button,src){if(!button._audio)button._audio=new Audio(src);const audio=button._audio;const icon=button.querySelector('i');const bars=button.nextElementSibling.children;if(!audio.paused){audio.pause();icon.className='fas fa-play';animateBars(!1)}else{audio.play();icon.className='fas fa-pause';animateBars(!0);audio.onended=()=>{icon.className='fas fa-play';animateBars(!1)}}
function animateBars(playing){Array.from(bars).forEach(bar=>{bar.style.animation=playing?'activeWave 0.6s ease-in-out infinite':'none';if(playing)bar.style.animationDelay=Math.random()+'s'})}};let currentMediaUrl='';function openMediaViewer(src,type){currentMediaUrl=src;const modal=document.getElementById('mediaViewerModal');const img=document.getElementById('mvImage');const vid=document.getElementById('mvVideo');modal.style.display='flex';if(type==='video'){img.style.display='none';vid.style.display='block';vid.src=src;vid.play().catch(e=>{})}else{vid.style.display='none';vid.pause();img.style.display='block';img.src=src}}
function closeMediaViewer(){const modal=document.getElementById('mediaViewerModal');const vid=document.getElementById('mvVideo');vid.pause();vid.src="";modal.style.display='none'}
function saveMedia(){if(!currentMediaUrl)return;const a=document.createElement('a');a.href=currentMediaUrl;a.download=`shakzz_media_${Date.now()}`;document.body.appendChild(a);a.click();document.body.removeChild(a)}
function appendMessage(msg,key){const isMe=msg.sender===state.userNickname;const isAI=msg.isAI;const row=document.createElement('div');row.id=`msg-row-${key}`;row.className=`message-row ${isMe ? 'me' : (isAI ? 'other ai' : 'other')}`;let content='';if(msg.replyTo)content+=`<div class="reply-quote-bubble"><strong>Replying to ${msg.replyTo.sender}</strong>${msg.replyTo.text}</div>`;if(msg.text){const emojiClass=isEmojiOnly(msg.text)?'emoji-only':'';content+=`<div class="${emojiClass}" style="margin-bottom:2px">${msg.text}</div>`}
if(msg.media){if(msg.media.startsWith('data:video')||msg.media.endsWith('.mp4')){content+=`
            <div style="position:relative; cursor:pointer;" onclick="ChatWidget.openMediaViewer('${msg.media}', 'video')">
                <video class="chat-media-content" src="${msg.media}" style="pointer-events:none;"></video>
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.5); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-play"></i></div>
            </div>`}else{content+=`<img class="chat-media-content" src="${msg.media}" alt="Media" onclick="ChatWidget.openMediaViewer('${msg.media}', 'image')">`}}
if(msg.audio){const waveHtml=Array(15).fill(0).map(()=>`<div class="audio-bar" style="height:${Math.floor(Math.random() * 15 + 5)}px"></div>`).join('');const minutes=Math.floor((msg.duration||0)/60);const seconds=((msg.duration||0)%60).toString().padStart(2,'0');content+=`
        <div class="audio-player">
          <button class="audio-play-btn" onclick="ChatWidget.playAudio(this, '${msg.audio}')"><i class="fas fa-play"></i></button>
          <div class="audio-waveform">${waveHtml}</div>
          <div class="audio-duration">${minutes}:${seconds}</div>
        </div>`}
const avatarUrl=isAI?'https://ui-avatars.com/api/?name=AI&background=00c6ff&color=fff':(msg.avatar||null);const avatar=avatarUrl?`<img src="${avatarUrl}" class="message-avatar">`:`<div class="message-avatar">${msg.sender?.[0] || '?'}</div>`;const actions=`
      <div class="actions-group">
        <button class="action-icon-btn" onclick="ChatWidget.showReactionPicker('${key}', this.closest('.message-row').querySelector('.chat-message'))"><i class="far fa-smile"></i></button>
        <button class="action-icon-btn" onclick="ChatWidget.triggerReplyFromIcon('${key}')"><i class="fas fa-reply"></i></button>
        <button class="action-icon-btn" onclick="ChatWidget.showDesktopMenu(event, '${key}', ${isMe})"><i class="fas fa-ellipsis-v"></i></button>
      </div>`;const time=new Date(msg.time);const timeStr=time.toLocaleTimeString('en-US',{hour:'numeric',minute:'numeric'});let statusHTML='';if(isMe){const displayStatus=String(key).startsWith('local-')?'Sending...':'Sent';statusHTML=`<div class="message-status-row"><span class="message-status-text">${displayStatus}</span></div>`}
const bubbleClass=(msg.text&&isEmojiOnly(msg.text)&&!msg.media&&!msg.audio)?'chat-message emoji-only':'chat-message';const bubbleHTML=`<div class="${bubbleClass}">${content}</div>`;if(isMe){row.innerHTML=`<div class="message-timestamp">${timeStr}</div><div class="chat-message-wrapper">${bubbleHTML}${statusHTML}${actions}</div>`}else{row.innerHTML=`<div class="message-timestamp">${timeStr}</div>${avatar}<div class="chat-message-wrapper"><div class="message-sender">${msg.sender}</div>${bubbleHTML}${actions}</div>`}
els.messages.appendChild(row);els.messages.scrollTop=els.messages.scrollHeight;if(state.isTouch){const bubble=row.querySelector('.chat-message')||row.querySelector('.chat-media-content');if(bubble){bubble.addEventListener('touchstart',e=>handleTouchStart(e,key));bubble.addEventListener('touchmove',handleTouchMove);bubble.addEventListener('touchend',handleTouchEnd)}}}
function loadMessages(){if(state.messagesRef){state.messagesRef.orderByChild('time').limitToLast(50).on('child_added',snapshot=>{appendMessage(snapshot.val(),snapshot.key)})}}
function openChat(){if(els.container)els.container.style.display='flex';if(els.fab)els.fab.style.display='none';init()}
function closeChat(){if(els.container)els.container.style.display='none';if(els.fab)els.fab.style.display='flex';if(state.cameraStream)state.cameraStream.getTracks().forEach(t=>t.stop());}
window.ChatWidget={init,openChat,closeChat,sendMessage,getAIResponse,clearFile,cancelReply,handleReaction,showDesktopMenu,openModal:()=>els.moreModal.style.display='flex',closeModal,closeDeleteModal,confirmDelete,triggerReplyFromIcon,handleModalAction,showReactionPicker,closeContextMode,playAudio:window.playAudio,openMediaViewer,closeMediaViewer,saveMedia};window.ChatSystem=window.ChatWidget})();function setupSearch(){const searchInput=document.getElementById("search");const clearBtn=document.getElementById("clearSearch");if(!searchInput||!clearBtn)return;searchInput.value="";clearBtn.style.display="none";searchInput.addEventListener("input",()=>{const val=searchInput.value.trim();clearBtn.style.display=val?"block":"none";renderChannelButtons(val);resetChannelListScroll()});clearBtn.addEventListener("click",()=>{searchInput.value="";clearBtn.style.display="none";renderChannelButtons("");resetChannelListScroll()})}
function setupCategoryTabs(){const desktop=document.querySelector(".category-bar");const mobile=document.getElementById("mobileCategoryList");if(!desktop||!mobile)return;const render=(container,isMobile)=>{container.innerHTML='';tabs.forEach((tab,index)=>{const btn=document.createElement('button');const isActive=index===0;btn.className=isMobile?`mobile-cat-option focusable-element ${isActive ? 'active' : ''}`:`category-button focusable-element ${isActive ? 'active' : ''}`;btn.textContent=tab.charAt(0).toUpperCase()+tab.slice(1);btn.addEventListener("click",()=>{currentTabIndex=index;document.querySelectorAll('.category-button, .mobile-cat-option').forEach(b=>b.classList.remove("active"));if(isMobile){mobile.querySelectorAll('button')[index]?.classList.add('active');desktop.querySelectorAll('button')[index]?.classList.add('active')}else{desktop.querySelectorAll('button')[index]?.classList.add('active');mobile.querySelectorAll('button')[index]?.classList.add('active')}
renderChannelButtons(currentSearchFilter);resetChannelListScroll();if(isMobile){document.getElementById('categoryModal')?.classList.remove('active');const mobileBtnText=document.getElementById('mobileCategoryBtn')?.querySelector('span');if(mobileBtnText)mobileBtnText.textContent=tab.charAt(0).toUpperCase()+tab.slice(1);}});container.appendChild(btn)})};render(desktop,!1);render(mobile,!0);const mobBtn=document.getElementById("mobileCategoryBtn");if(mobBtn){mobBtn.addEventListener('click',()=>{document.getElementById('categoryModal')?.classList.add('active');setTimeout(()=>{const first=document.querySelector('#mobileCategoryList .focusable-element');if(first)setTvFocus(first);},100)});document.getElementById('closeCategoryModal')?.addEventListener('click',()=>document.getElementById('categoryModal')?.classList.remove('active'))}}
function setupHamburgerMenu(){const hamburger=document.getElementById('hamburger');const mobileMenu=document.getElementById('navPages');if(!hamburger||!mobileMenu)return;hamburger.addEventListener('click',()=>{const isActive=hamburger.classList.toggle('active');mobileMenu.classList.toggle('active',isActive);document.body.classList.toggle('mobile-menu-active',isActive);if(isActive){setTimeout(()=>{const firstLink=document.querySelector('#navPages a:first-child');if(firstLink)setTvFocus(firstLink);},100)}else{clearTvFocus()}});mobileMenu.querySelectorAll('a').forEach(link=>{link.addEventListener('click',(e)=>{e.preventDefault();const targetId=link.getAttribute('href');const targetElement=document.querySelector(targetId);hamburger.classList.remove('active');mobileMenu.classList.remove('active');document.body.classList.remove('mobile-menu-active');clearTvFocus();if(targetElement){const headerHeight=document.querySelector('.page-header')?.offsetHeight||0;window.scrollTo({top:targetElement.offsetTop-headerHeight,behavior:'smooth'})}else if(targetId==="#main-content-area"){window.scrollTo({top:0,behavior:'smooth'})}})})}
function setupWelcomeModal(){if(sessionStorage.getItem('welcomeModalShown'))return;const modal=document.getElementById('welcomeModal');const closeBtn=document.getElementById('closeModalBtn');const countdownSpan=document.getElementById('modalCountdown');if(!modal||!closeBtn||!countdownSpan)return;let countdown=5;let countdownInterval;const closeModal=()=>{modal.classList.remove('active');clearInterval(countdownInterval);sessionStorage.setItem('welcomeModalShown','true')};const startCountdown=()=>{countdownSpan.textContent=countdown;countdownInterval=setInterval(()=>{countdown--;countdownSpan.textContent=countdown;if(countdown<=0)closeModal();},1000)};closeBtn.addEventListener('click',closeModal);modal.classList.add('active');startCountdown();setTimeout(()=>{setTvFocus(closeBtn)},100)}
function setupQrCodeModal(){const qrCodeImage=document.querySelector('.donation-qr-code');const qrModal=document.getElementById('qrModal');const zoomedQrImage=document.getElementById('zoomedQrImage');const closeQrModalBtn=document.getElementById('closeQrModalBtn');if(!qrCodeImage||!qrModal||!zoomedQrImage||!closeQrModalBtn)return;qrCodeImage.addEventListener('click',()=>{qrModal.classList.add('active');zoomedQrImage.src=qrCodeImage.src;setTimeout(()=>setTvFocus(closeQrModalBtn),50)});closeQrModalBtn.addEventListener('click',()=>{qrModal.classList.remove('active');clearTvFocus()})}
function setupBackToTopButton(){const backToTopButton=document.getElementById('backToTopBtn');const aboutSection=document.getElementById('about-us');if(!backToTopButton||!aboutSection)return;window.addEventListener('scroll',()=>{backToTopButton.classList.toggle('show',window.scrollY>aboutSection.offsetTop)});backToTopButton.addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'})})}
function setupNotificationSystem(){const banner=document.getElementById('liveNotificationBanner');const msgEl=document.getElementById('notificationMessage');const closeBtn=document.getElementById('closeNotificationBtn');const NOTIFICATION_URL='notification.json';const SESSION_KEY='notificationClosed';let currentNotificationId=null;if(!banner)return;closeBtn.addEventListener('click',()=>{banner.classList.remove('show');banner.classList.add('hide');sessionStorage.setItem(SESSION_KEY,currentNotificationId||'true')});async function fetchNotification(){if(document.getElementById('maintenanceOverlay')?.classList.contains('active')||document.getElementById('welcomeModal')?.classList.contains('active'))return;const controller=new AbortController();setTimeout(()=>controller.abort(),2000);try{const response=await fetch(`${NOTIFICATION_URL}?t=${Date.now()}`,{signal:controller.signal});if(!response.ok)return;const data=await response.json();const lastClosed=sessionStorage.getItem(SESSION_KEY);const shouldShow=data.show&&(lastClosed!==data.id);currentNotificationId=data.id;if(shouldShow){msgEl.innerHTML=data.message;banner.classList.remove('info','success','alert','hide');banner.classList.add(data.type||'alert');banner.style.display='flex';setTimeout(()=>banner.classList.add('show'),10);setTimeout(()=>{banner.classList.remove('show');banner.classList.add('hide')},8000)}}catch(error){}}
setTimeout(fetchNotification,2000);notificationInterval=setInterval(fetchNotification,15000)}
function setupScrollSpy(){const sections=document.querySelectorAll('section[id]');const navLinks=document.querySelectorAll('.nav-pages a');const highlighter=document.querySelector('.nav-highlight');if(!highlighter)return;const moveHighlight=(link)=>{highlighter.style.width=`${link.offsetWidth}px`;highlighter.style.left=`${link.offsetLeft}px`;highlighter.style.opacity='1';navLinks.forEach(l=>l.classList.remove('active-link'));link.classList.add('active-link')};const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){const id=entry.target.getAttribute('id');const activeLink=document.querySelector(`.nav-pages a[href="#${id}"]`);if(activeLink)moveHighlight(activeLink);}})},{rootMargin:'-50% 0px -40% 0px'});sections.forEach(section=>observer.observe(section))}
function getFocusableElements(){const elements=document.querySelectorAll('.focusable-element:not([style*="display: none"]):not([disabled]):not([hidden]):not([aria-hidden="true"])');return Array.from(elements).filter(el=>{const style=window.getComputedStyle(el);return style.visibility!=='hidden'&&style.opacity!=='0'&&style.display!=='none'})}
function setTvFocus(el){if(focusedElement)focusedElement.classList.remove('tv-focus');focusedElement=el;if(focusedElement){focusedElement.classList.add('tv-focus');focusedElement.scrollIntoView({block:'center',behavior:'smooth'})}}
function clearTvFocus(){if(focusedElement)focusedElement.classList.remove('tv-focus');focusedElement=null}
function findNextSpatialFocus(direction){const currentEl=focusedElement;if(!currentEl)return getFocusableElements()[0];const rect1=currentEl.getBoundingClientRect();const candidates=getFocusableElements().filter(el=>el!==currentEl);let bestCandidate=null;let minDistance=Infinity;const getCenter=(r)=>({x:r.left+r.width/2,y:r.top+r.height/2});const center1=getCenter(rect1);candidates.forEach(cand=>{const rect2=cand.getBoundingClientRect();const center2=getCenter(rect2);let isValid=!1;switch(direction){case 'right':isValid=rect2.left>=center1.x;break;case 'left':isValid=rect2.right<=center1.x;break;case 'down':isValid=rect2.top>=center1.y;break;case 'up':isValid=rect2.bottom<=center1.y;break}
if(isValid){const dx=center2.x-center1.x;const dy=center2.y-center1.y;const distance=Math.hypot(dx,dy);const penalty=(direction==='up'||direction==='down')?Math.abs(dx)*2:Math.abs(dy)*2;const score=distance+penalty;if(score<minDistance){minDistance=score;bestCandidate=cand}}});return bestCandidate}
function setupTvRemoteLogic(){window.addEventListener('keydown',(e)=>{const isInputActive=document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='TEXTAREA'||document.activeElement.isContentEditable;if(e.key==='Escape'||e.key==='Backspace'||e.key==='Back'||e.key==='Exit'){if(e.key==='Backspace'&&isInputActive)return;e.preventDefault();if(document.getElementById('qrModal')?.classList.contains('active')){document.getElementById('closeQrModalBtn').click();return}
if(document.getElementById('categoryModal')?.classList.contains('active')){document.getElementById('closeCategoryModal').click();return}
if(document.getElementById('navPages')?.classList.contains('active')){document.getElementById('hamburger').click();return}
if(document.getElementById('welcomeModal')?.classList.contains('active')){document.getElementById('closeModalBtn').click();return}
if(document.getElementById('mediaViewerModal')?.style.display==='flex'){window.ChatWidget.closeMediaViewer();return}
if(document.getElementById('chatContainer')?.style.display==='flex'){window.ChatWidget.closeChat();return}
if(window.scrollY>0){window.scrollTo({top:0,behavior:'smooth'});return}}
let direction=null;switch(e.key){case 'ArrowUp':direction='up';break;case 'ArrowDown':direction='down';break;case 'ArrowLeft':direction='left';break;case 'ArrowRight':direction='right';break;case 'Enter':if(focusedElement){focusedElement.click();if(focusedElement.tagName==='INPUT')focusedElement.focus();e.preventDefault()}
return}
if(direction){e.preventDefault();const nextElement=findNextSpatialFocus(direction);if(nextElement)setTvFocus(nextElement);}});window.addEventListener('load',()=>{const searchInput=document.getElementById('search');if(searchInput)setTvFocus(searchInput);})}
function validateRequirements(){const errors=[];if(typeof channels==='undefined')errors.push("Channels data not loaded");else if(!channels||Object.keys(channels).length===0)errors.push("Channels object is empty");if(!document.getElementById('channelList'))errors.push("#channelList missing");if(!document.getElementById('video'))errors.push("#video missing");return errors}
function setupMaintenanceMode(){const CHECK_INTERVAL=5000;let isUnderMaintenance=!1;return new Promise((resolve)=>{async function checkStatus(){const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),2000);try{const response=await fetch(`config.json?t=${Date.now()}`,{cache:"no-store",signal:controller.signal,headers:{'Cache-Control':'no-cache'}});clearTimeout(timeoutId);if(!response.ok){resolve();return}
const config=await response.json();const overlay=document.getElementById('maintenanceOverlay');const msgEl=document.getElementById('maintenanceMessage');if(config.maintenanceMode===!0){if(msgEl)msgEl.textContent=config.message;if(!isUnderMaintenance){isUnderMaintenance=!0;window.stop();if(window.jwplayer){try{jwplayer().stop();jwplayer().remove()}catch(e){}}
if(viewerInterval)clearInterval(viewerInterval);if(notificationInterval)clearInterval(notificationInterval);['.page-header','#liveNotificationBanner','#main-content-area','#about-us','#updates','#privacy-policy','#contact','#welcomeModal','#qrModal','#categoryModal','#backToTopBtn','#mini-messenger-root'].forEach(sel=>{const el=document.querySelector(sel);if(el)el.style.display='none'});if(overlay){overlay.classList.add('active');document.body.style.overflow='hidden'}}}else if(isUnderMaintenance){location.reload()}}catch(error){}
resolve()}
checkStatus().then(resolve);maintenanceInterval=setInterval(checkStatus,CHECK_INTERVAL)})}
function setupScrollReveal(){if(document.getElementById('maintenanceOverlay')?.classList.contains('active'))return;const elements=document.querySelectorAll('.scroll-reveal');if(elements.length===0)return;setTimeout(()=>{document.body.classList.add('animations-ready')},500);const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add('active');entry.target.classList.remove('reveal-init')}})},{root:null,threshold:0.15});elements.forEach(el=>observer.observe(el))}
function resetChannelListScroll(){const scrollableListContainer=document.querySelector(".scrollable-list");if(scrollableListContainer)scrollableListContainer.scrollTop=0}
function getOrCreateDeviceId(){let deviceId=localStorage.getItem('deviceId');if(!deviceId){deviceId=window.crypto?.randomUUID?.()||'xxxxxxxx'.replace(/[xy]/g,c=>(Math.random()*16|0).toString(16));localStorage.setItem('deviceId',deviceId)}
return deviceId}
function removeSkeletonLoader(){const skeletonElements=document.querySelectorAll('.skeleton-effect');skeletonElements.forEach(el=>{el.classList.add('skeleton-fade-out');el.classList.remove('skeleton-effect');setTimeout(()=>{el.classList.remove('skeleton-fade-out')},500)})}
async function updateViewerCount(){if(document.getElementById('maintenanceOverlay')?.classList.contains('active'))return;const controller=new AbortController();setTimeout(()=>controller.abort(),3000);try{const deviceId=getOrCreateDeviceId();const res=await fetch(`/api/viewers?deviceId=${deviceId}`,{signal:controller.signal});const data=await res.json();const viewerCountEl=document.getElementById('viewerCountText');if(viewerCountEl)viewerCountEl.innerText=data.count||0}catch(e){}}
function loadFavoritesFromStorage(){try{const stored=JSON.parse(localStorage.getItem("favoriteChannels")||"[]");if(typeof channels!=='undefined'){Object.entries(channels).forEach(([key,channel])=>{channel.favorite=stored.includes(key)})}}catch(e){}}
function saveFavoritesToStorage(){if(typeof channels==='undefined')return;try{const favorites=Object.entries(channels).filter(([key,ch])=>ch.favorite).map(([key])=>key);localStorage.setItem("favoriteChannels",JSON.stringify(favorites))}catch(e){}}
function renderChannelButtons(filter=""){currentSearchFilter=filter;const list=document.getElementById("channelList");if(!list){CutieLoader.error("Channel list element missing");return}
setTimeout(removeSkeletonLoader,800);if(typeof channels==='undefined'){list.innerHTML=`<div class="cutie-error-msg">Error: channels data not loaded.</div>`;return}
if(sortedChannels.length===0){list.innerHTML=`<div class="cutie-error-msg">No channels available.</div>`;return}
list.innerHTML="";shownCount=0;const selectedGroup=tabs[currentTabIndex];const fragment=document.createDocumentFragment();sortedChannels.forEach(([key,channel])=>{const group=channel.group||"live";const matchesSearch=channel.name.toLowerCase().includes(filter.toLowerCase());const matchesFavorites=(selectedGroup==="favorites")?channel.favorite===!0:!0;const matchesGroup=selectedGroup==="all"||selectedGroup==="favorites"||(Array.isArray(group)?group.includes(selectedGroup):group===selectedGroup);if(!matchesSearch||!matchesGroup||!matchesFavorites)return;const btn=document.createElement("button");const isActive=(key===currentChannelKey);btn.className=isActive?"channel-button focusable-element active":"channel-button focusable-element";btn.setAttribute("data-key",key);const logo=document.createElement("img");logo.src=channel.logo;logo.className="channel-logo";logo.loading="lazy";logo.onerror=function(){this.style.backgroundColor='#333';this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiPjxwYXRoIGQ9Ik0yMSA5djEwYTIgMiAwIDAgMS0yIDJNMTEgMTVhNSA1IDAgMSAwLTEwIDAgNSA1IDAgMCAwIDEwIDBtNSAyTDcgMTIiL3N2Zz4='};const nameSpan=document.createElement("span");nameSpan.className="channel-name";nameSpan.textContent=channel.name;const favStar=document.createElement("span");favStar.className="favorite-star";favStar.innerHTML=channel.favorite?"â­":"â˜†";favStar.onclick=(e)=>{e.stopPropagation();channel.favorite=!channel.favorite;favStar.innerHTML=channel.favorite?"â­":"â˜†";saveFavoritesToStorage();renderChannelButtons(currentSearchFilter)};btn.appendChild(logo);btn.appendChild(nameSpan);btn.appendChild(favStar);btn.onclick=()=>loadChannel(key);fragment.appendChild(btn);shownCount++});list.appendChild(fragment);const countDisplay=document.getElementById("channelCountText");if(countDisplay)countDisplay.textContent=`${shownCount} channel${shownCount !== 1 ? "s" : ""} found`;const clearBtnEls=document.querySelectorAll('#clearFavoritesBtn');clearBtnEls.forEach(btn=>{if(btn)btn.style.display=(selectedGroup==="favorites"&&shownCount>0)?"block":"none"})}
async function loadChannel(key){if(typeof channels==="undefined")return;const channel=channels[key];if(!channel)return;currentChannelKey=key;localStorage.setItem("lastPlayedChannel",key);document.querySelectorAll(".channel-button").forEach(btn=>{btn.classList.remove("active");if(btn.getAttribute("data-key")===key)btn.classList.add("active");});const nowPlayingEl=document.getElementById("nowPlayingChannel");if(nowPlayingEl){nowPlayingEl.textContent=channel.name;const overlay=document.getElementById("nowPlayingOverlay");if(overlay){overlay.classList.add("now-playing-animate");setTimeout(()=>overlay.classList.remove("now-playing-animate"),350)}}
let playerType="hls";let drmConfig=undefined;if(channel.type==="clearkey"){playerType="dash";if(channel.keyId&&channel.key){drmConfig={clearkey:{keyId:channel.keyId,key:channel.key}}}}
if(channel.type==="widevine"){playerType="dash";drmConfig={widevine:{url:channel.licenseServerUri}}}
if(channel.type==="hls")playerType="hls";if(channel.type==="mp4")playerType="mp4";try{jwplayer("video").setup({autostart:!0,width:"100%",aspectratio:"16:9",stretching:"exactfit",sources:[{file:channel.manifestUri,type:playerType,drm:drmConfig}]})}catch(e){console.error("JWPlayer setup error:",e)}}
document.addEventListener('DOMContentLoaded',async()=>{if(typeof CutieLoader!=='undefined')CutieLoader.show("Initializing Shakzz TV...");try{const validationErrors=validateRequirements();if(validationErrors.length>0){throw new Error(`Missing requirements: ${validationErrors.join(', ')}`)}
await Promise.race([setupMaintenanceMode(),new Promise((_,reject)=>setTimeout(()=>reject('Maintenance check timeout'),4000))]);if(window.ChatSystem)window.ChatSystem.init();setupScrollReveal();setupSearch();setupCategoryTabs();setupWelcomeModal();setupHamburgerMenu();setupBackToTopButton();setupQrCodeModal();setupNotificationSystem();setupScrollSpy();setupTvRemoteLogic();if(typeof channels!=='undefined'){sortedChannels=Object.entries(channels).sort((a,b)=>a[1].name.localeCompare(b[1].name));loadFavoritesFromStorage();const lastPlayed=localStorage.getItem("lastPlayedChannel");if(lastPlayed&&channels[lastPlayed]){currentChannelKey=lastPlayed}else if(channels[DEFAULT_CHANNEL_ID]){currentChannelKey=DEFAULT_CHANNEL_ID}else{currentChannelKey=sortedChannels[0]?.[0]||""}}
renderChannelButtons();resetChannelListScroll();if(currentChannelKey)loadChannel(currentChannelKey);updateViewerCount();viewerInterval=setInterval(updateViewerCount,5000);if(typeof CutieLoader!=='undefined')CutieLoader.hide();console.log("âœ… Shakzz TV System Ready")}catch(error){console.error("âŒ System initialization failed:",error);removeSkeletonLoader();if(typeof CutieLoader!=='undefined')CutieLoader.error(error.message||"Failed to load.");}})
